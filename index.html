
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Автовыкладка ВКонтакте</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    button { margin: 5px; padding: 10px; }
    pre { background: #f0f0f0; padding: 10px; max-height: 300px; overflow-y: scroll; }
  </style>
</head>
<body>
  <h1>Автовыкладка постов ВКонтакте</h1>
  <button onclick="loadPosts()">Загрузить предложку</button>
  <button onclick="checkPosts()">Проверить посты</button>
  <button onclick="postAll()">Выложить все подходящие</button>
  <button onclick="deleteRejected()">Удалить неподходящие</button>
  <button onclick="toggleAuto()">Автовыкладка: <span id='autoState'>выключена</span></button>
  <pre id="log"></pre>

  <script>
    const groupId = 136706358;
    const token = "vk1.a.RwQAMDzAKOLOVWXNGaFusWEyDxGI_aUUVzavBjP3L0AlYLvM8jyV0cVAzQyB0zOym8iiCywQXAhMUGQlUM5QnRLjZT5EYreEv-Z4IFYn12b9mAI1aJDsWWuUv_rHuf3yyPzam2i7i193de8OVnCfUeTuPuN7NHWlbBANwK2qV9ohqUY3fBJI__VZo8e7batb2CWcg9ECNqrH_W_YX2vPsw";

    const firebaseConfig = {
      apiKey: "AIzaSyD-test-key",
      authDomain: "sasha-poster.firebaseapp.com",
      databaseURL: "https://sasha-poster-default-rtdb.firebaseio.com",
      projectId: "sasha-poster",
      storageBucket: "sasha-poster.appspot.com",
      messagingSenderId: "1234567890",
      appId: "1:1234567890:web:test"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const log = (msg) => {
      const out = document.getElementById("log");
      out.textContent += msg + "\n";
      out.scrollTop = out.scrollHeight;
    };

    let cachedPosts = [];

    async function loadPosts() {
      document.getElementById("log").textContent = "";
      log("Загружаю предложку...");
      try {
        const resp = await fetch(`https://api.vk.com/method/wall.get?owner_id=-${groupId}&filter=suggests&count=100&access_token=${token}&v=5.199`);
        const data = await resp.json();
        if (!data.response) return log("Ошибка загрузки: " + JSON.stringify(data));
        cachedPosts = data.response.items;
        log(`Загружено постов: ${cachedPosts.length}`);
      } catch (e) {
        log("Ошибка при загрузке: " + e);
      }
    }

    function extractPhone(text) {
      const match = text.match(/(?:\+7|8)?[\s\-]?\(?\d{3}\)?[\s\-]?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}/);
      return match ? match[0].replace(/\D/g, "") : null;
    }

    async function checkPosts() {
      if (!cachedPosts.length) return log("Сначала загрузите предложку.");
      log("Проверяю посты...");
      const now = Date.now();
      const oneDay = 86400000;
      for (const post of cachedPosts) {
        const uid = post.from_id;
        const text = post.text;
        const phone = extractPhone(text);
        let reasons = [];

        const uidSnap = uid ? await db.ref("uids/" + uid).get() : null;
        const phoneSnap = phone ? await db.ref("phones/" + phone).get() : null;

        const uidOld = uidSnap && uidSnap.exists() && now - uidSnap.val().timestamp < oneDay;
        const phoneOld = phoneSnap && phoneSnap.exists() && now - phoneSnap.val().timestamp < oneDay;

        if (!phone) reasons.push("нет телефона");
        if (uidOld) reasons.push("повторный ID");
        if (phoneOld) reasons.push("повторный номер");

        if (reasons.length) {
          post.rejected = true;
          log(`Отклонён пост ${post.id}: ${reasons.join(", ")}`);
        } else {
          log(`Подходит: ${post.id}`);
          if (uid) await db.ref("uids/" + uid).set({ timestamp: now });
          if (phone) await db.ref("phones/" + phone).set({ timestamp: now });
        }
      }
      log("Проверка завершена.");
    }

    async function postAll() {
      for (const post of cachedPosts) {
        if (!post.rejected) {
          const res = await fetch(`https://api.vk.com/method/wall.post?owner_id=-${groupId}&from_group=0&message=${encodeURIComponent(post.text)}&access_token=${token}&v=5.199`);
          const data = await res.json();
          log(data.response ? `Выложен пост ${post.id}` : `Ошибка при выкладке ${post.id}`);
        }
      }
    }

    async function deleteRejected() {
      for (const post of cachedPosts) {
        if (post.rejected) {
          await fetch(`https://api.vk.com/method/wall.delete?owner_id=-${groupId}&post_id=${post.id}&access_token=${token}&v=5.199`);
          log(`Удалён пост ${post.id}`);
        }
      }
    }

    let auto = false;
    let interval;

    function toggleAuto() {
      auto = !auto;
      document.getElementById("autoState").textContent = auto ? "включена" : "выключена";
      if (auto) {
        interval = setInterval(async () => {
          await loadPosts();
          await checkPosts();
          await postAll();
        }, 5 * 60 * 1000);
      } else {
        clearInterval(interval);
      }
    }
  </script>
</body>
</html>
