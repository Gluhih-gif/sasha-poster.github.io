
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Выкладка постов из предложки</title>
    <style>
        body { font-family: sans-serif; }
        button, input { font-size: 16px; margin: 4px; }
        pre { background: #f0f0f0; padding: 10px; height: 200px; overflow: auto; }
    </style>
</head>
<body>
    <h2>Выкладка постов из предложки</h2>
    Access Token:<br>
    <input type="text" id="token" placeholder="Вставьте ваш access_token">
    <br>
    Время выкладки (часы:минуты):<br>
    <input type="time" id="postTime" value="10:00"><br>
    <button onclick="startAutoPost()">Запустить автовыкладку</button>
    <button onclick="stopAutoPost()">Остановить</button>
    <button onclick="postNow()">Выложить всё сейчас</button>
    <button onclick="checkPosts()">Проверить посты (по ID и телефонам)</button>
    <pre id="log"></pre>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA2ziFMtskwVS59TYpylzRYYPm3KUaHRZM",
            authDomain: "vk-post-filter.firebaseapp.com",
            databaseURL: "https://vk-post-filter-default-rtdb.firebaseio.com",
            projectId: "vk-post-filter",
            storageBucket: "vk-post-filter.appspot.com",
            messagingSenderId: "870137473414",
            appId: "1:870137473414:web:df8b501b64a63b4c3a2407"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const GROUP_ID = 136706358;
        const OWNER_ID = -GROUP_ID;
        let token = localStorage.getItem("vk_token") || "";
        if (token) document.getElementById("token").value = token;

        document.getElementById("token").addEventListener("input", (e) => {
            token = e.target.value;
            localStorage.setItem("vk_token", token);
        });

        const log = (msg) => {
            const el = document.getElementById("log");
            el.textContent += `[${new Date().toLocaleTimeString()}] ${msg}
`;
            el.scrollTop = el.scrollHeight;
        };

        async function checkPosts() {
            if (!token) return log("Токен не введён");
            log("Загрузка постов из предложки...");
            const url = `https://api.vk.com/method/wall.get?owner_id=${OWNER_ID}&filter=suggests&count=100&access_token=${token}&v=5.131`;
            const res = await fetch(url);
            const data = await res.json();

            if (!data.response || !data.response.items) return log("Ошибка загрузки предложки");

            const posts = data.response.items;
            const snapshot = await db.ref("history").get();
            const history = snapshot.val() || {};
            const now = Date.now();

            const uniquePosts = [];
            for (const post of posts) {
                const text = post.text;
                const id = post.from_id;
                const phoneMatch = text.match(/(?:\+7|8)[\s-]?\(?\d{3}\)?[\s-]?\d{3}[\s-]?\d{2}[\s-]?\d{2}/);
                const phone = phoneMatch ? phoneMatch[0].replace(/\D/g, "") : null;

                if (history[id] || (phone && history[phone])) {
                    log(`Пропущено: ID ${id} или номер ${phone} уже есть`);
                    continue;
                }

                if (phone) history[phone] = now;
                history[id] = now;
                uniquePosts.push(post);
            }

            await db.ref("history").set(history);
            log(`Принято постов: ${uniquePosts.length}`);
        }

        async function postNow() {
            if (!token) return log("Токен не введён");
            log("Выкладываю посты...");

            const url = `https://api.vk.com/method/wall.get?owner_id=${OWNER_ID}&filter=suggests&count=100&access_token=${token}&v=5.131`;
            const res = await fetch(url);
            const data = await res.json();
            const posts = data.response.items || [];

            for (const post of posts) {
                const msg = post.text;
                const attachments = post.attachments?.map(a => `${a.type}${a[a.type]?.owner_id}_${a[a.type]?.id}`).join(",") || "";
                const pub = `https://api.vk.com/method/wall.post?owner_id=${OWNER_ID}&from_group=0&message=${encodeURIComponent(msg)}&attachments=${attachments}&access_token=${token}&v=5.131`;
                await fetch(pub);
                log("Пост выложен");
            }
        }

        let timer = null;
        function startAutoPost() {
            const timeStr = document.getElementById("postTime").value;
            const [hour, minute] = timeStr.split(":").map(Number);
            timer = setInterval(() => {
                const now = new Date();
                if (now.getHours() === hour && now.getMinutes() === minute) {
                    postNow();
                }
            }, 30000);
            log("Автовыкладка включена");
        }

        function stopAutoPost() {
            clearInterval(timer);
            log("Автовыкладка остановлена");
        }

        // Очистка истории старше 24 часов
        setInterval(async () => {
            const snapshot = await db.ref("history").get();
            const history = snapshot.val() || {};
            const now = Date.now();
            const day = 24 * 60 * 60 * 1000;
            const filtered = {};
            for (const key in history) {
                if (now - history[key] < day) {
                    filtered[key] = history[key];
                }
            }
            await db.ref("history").set(filtered);
            log("История очищена от старых записей");
        }, 3600000); // Проверка каждый час
    </script>
</body>
</html>
