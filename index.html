
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Выкладка из предложки</title>
</head>
<body>
  <h2>Выкладка постов из предложки</h2>
  <button onclick="startPosting()">Запустить выкладку</button>
  <pre id="log"></pre>

  <script>
    const GROUP_ID = 136706358;
    const OWNER_ID = -136706358;
    let token = "";

    function log(msg) {
      const logEl = document.getElementById("log");
      logEl.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
    }

    async function startPosting() {
      if (!token) {
        await getToken();
      }
      log("Получение предложки...");
      const suggests = await fetch(`https://api.vk.com/method/wall.get?owner_id=${OWNER_ID}&filter=suggests&count=100&access_token=${token}&v=5.154`)
        .then(res => res.json());

      if (!suggests.response || !suggests.response.items.length) {
        log("Нет постов в предложке.");
        return;
      }

      for (const post of suggests.response.items) {
        const message = post.text;
        const postId = post.id;

        const attachList = post.attachments?.map(att => {
          if (att.type === "photo" || att.type === "video" || att.type === "doc") {
            const item = att[att.type];
            return `${att.type}${item.owner_id}_${item.id}`;
          }
          return "";
        }).filter(Boolean);

        const attachments = attachList?.join(",") || "";

        const res = await fetch("https://api.vk.com/method/wall.post", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({
            owner_id: `-${GROUP_ID}`,
            message,
            attachments,
            access_token: token,
            v: "5.154"
          })
        }).then(res => res.json());

        if (res.response) {
          log(`Опубликован пост ${postId}`);
          await fetch("https://api.vk.com/method/wall.delete?" + new URLSearchParams({
            owner_id: OWNER_ID,
            post_id: postId,
            access_token: token,
            v: "5.154"
          }));
          log(`Удалён из предложки ${postId}`);
        } else {
          log(`Ошибка поста ${postId}: ${JSON.stringify(res.error)}`);
        }

        await new Promise(r => setTimeout(r, 10000));
      }
    }

    async function getToken() {
      return new Promise((resolve) => {
        const client_id = 6121396;
        const scope = "wall,groups,offline";
        const auth_url = `https://oauth.vk.com/authorize?client_id=${client_id}&display=page&redirect_uri=https://oauth.vk.com/blank.html&scope=${scope}&response_type=token&v=5.154`;

        const popup = window.open(auth_url, "_blank", "width=600,height=600");

        const timer = setInterval(() => {
          try {
            if (popup.location.href.includes("access_token")) {
              const hash = popup.location.hash.substring(1);
              const params = new URLSearchParams(hash);
              token = params.get("access_token");
              popup.close();
              clearInterval(timer);
              log("Токен получен");
              resolve(token);
            }
          } catch (e) {}
        }, 500);
      });
    }
  </script>
</body>
</html>
