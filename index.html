<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>VK Постер — Проверка предложки</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f9f9f9; }
    button { padding: 10px 15px; margin: 5px; background: #007acc; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #005fa3; }
    .log { margin-top: 20px; padding: 10px; background: #fff; height: 300px; overflow-y: auto; border-radius: 5px; }
    .bad { color: red; }
    .good { color: green; }
  </style>
</head>
<body>
<h1>VK Постер — Фильтрация предложки</h1>
<button onclick="fetchPosts()">Загрузить предложку</button>
<button onclick="checkPosts()">Проверить посты</button>
<button onclick="clearBad()">Удалить неподходящие</button>
<button onclick="postAll()">Выложить подходящие</button>
<div class="log" id="log">[Готов к работе]</div>
<script>
let posts = [];

function log(msg, type = '') {
  const el = document.getElementById("log");
  const time = new Date().toLocaleTimeString();
  el.innerHTML += `<div class="${type}">[${time}] ${msg}</div>`;
  el.scrollTop = el.scrollHeight;
}

function fetchPosts() {
  log("Загружаем предложку...");
  fetch("http://localhost:5000/get_suggestions")
    .then(r => r.json())
    .then(data => {
      if (data.response?.items) {
        posts = data.response.items.map(p => ({ ...p, bad: false }));
        log("Получено постов: " + posts.length, "good");
      } else {
        log("Ошибка ответа: " + JSON.stringify(data), "bad");
      }
    })
    .catch(err => {
      log("Ошибка загрузки: " + err.message, "bad");
    });
}

function normalizePhones(text) {
  const matches = text.match(/(?:\+7|8)?\D?(\d{3})\D?(\d{3})\D?(\d{2})\D?(\d{2})/g);
  return matches ? matches.map(p => p.replace(/\D/g, '').replace(/^8/, '7')) : [];
}

function checkPosts() {
  const seenIDs = new Set();
  const seenPhones = new Set();
  const now = Date.now();

  posts.forEach(p => {
    p.bad = false;
    const uid = p.from_id;
    const phones = normalizePhones(p.text || '');

    if (seenIDs.has(uid)) {
      log(`Удалён ${p.id}: повтор ID`, "bad");
      p.bad = true;
    } else if (!phones.length) {
      log(`Удалён ${p.id}: нет номера`, "bad");
      p.bad = true;
    } else if (phones.some(ph => seenPhones.has(ph))) {
      log(`Удалён ${p.id}: повтор телефона`, "bad");
      p.bad = true;
    }

    if (!p.bad) {
      seenIDs.add(uid);
      phones.forEach(ph => seenPhones.add(ph));
    }
  });

  const valid = posts.filter(p => !p.bad).length;
  log(`Подходящих постов: ${valid}`, "good");
}

function clearBad() {
  const before = posts.length;
  posts = posts.filter(p => !p.bad);
  log(`Удалено: ${before - posts.length}`, "bad");
}

function postAll() {
  const queue = posts.filter(p => !p.bad);
  if (!queue.length) {
    log("Нет подходящих постов для публикации", "bad");
    return;
  }

  let i = 0;
  function next() {
    if (i >= queue.length) {
      log("Выкладка завершена", "good");
      return;
    }
    const post = queue[i];
    fetch("http://localhost:5000/post", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        message: post.text,
        attachments: post.attachments || [],
        post_id: post.id
      })
    }).then(r => r.json()).then(data => {
      if (data.response?.post_id) {
        log(`Выложен пост ${post.id} → ${data.response.post_id}`, "good");
      } else {
        log(`Ошибка при выкладке ${post.id}: ` + JSON.stringify(data), "bad");
      }
      i++;
      setTimeout(next, 3000);
    }).catch(err => {
      log("Ошибка отправки: " + err.message, "bad");
      i++;
      setTimeout(next, 3000);
    });
  }
  next();
}
</script>
</body>
</html>