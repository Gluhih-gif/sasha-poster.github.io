
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>VK Постер (финальная версия)</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
    input, button, select { padding: 10px; font-size: 16px; margin-top: 10px; margin-right: 10px; }
    pre { background: #eee; padding: 10px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>VK Постер — Автовыкладка от имени авторов</h2>

  <label>Время выкладки:</label>
  <input type="time" id="postTime" value="10:00" />
  <button onclick="startAutoPost()">Запустить автовыкладку</button>
  <button onclick="stopAutoPost()">Остановить</button>
  <button onclick="checkPosts()">Проверить посты</button>
  <button onclick="postAll()">Выложить всё сейчас</button>
  <pre id="log"></pre>

<script>
const TOKEN = "vk1.your_real_token_here"; // ВСТРОЕННЫЙ ВЕЧНЫЙ ТОКЕН
const OWNER_ID = -136706358;
let autoPostInterval = null;

function log(msg) {
  const el = document.getElementById("log");
  el.textContent += `[${new Date().toLocaleTimeString()}] ${msg}
`;
  el.scrollTop = el.scrollHeight;
}

async function fetchSuggests() {
  const url = `https://api.vk.com/method/wall.get?owner_id=${OWNER_ID}&filter=suggests&count=100&access_token=${TOKEN}&v=5.199`;
  const res = await fetch(url);
  const data = await res.json();
  return data.response ? data.response.items : [];
}

function startAutoPost() {
  const [hours, minutes] = document.getElementById("postTime").value.split(":").map(Number);
  stopAutoPost();
  log(`Автовыкладка запущена на ${hours}:${minutes}`);
  autoPostInterval = setInterval(async () => {
    const now = new Date();
    if (now.getHours() === hours && now.getMinutes() === minutes) {
      log("Время пришло — запускаем выкладку");
      await postAll();
    }
  }, 60000);
}

function stopAutoPost() {
  clearInterval(autoPostInterval);
  log("Автовыкладка остановлена");
}

async function checkPosts() {
  const posts = await fetchSuggests();
  let count = 0;
  for (const post of posts) {
    const idOk = !localStorage.getItem("id_" + post.from_id);
    const phoneMatch = post.text.match(/(?:\+7|8)?[\s\-]?\(?\d{3}\)?[\s\-]?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}/);
    const phoneOk = phoneMatch && !localStorage.getItem("phone_" + phoneMatch[0]);
    const hasYear = /(?:19|20)\d{2}/.test(post.text);
    const hasMileage = /\b\d{{2,6}}\s?(км|тыс)/i.test(post.text);
    const hasPrice = /\b\d{{5,8}}\b/.test(post.text);
    if (idOk && phoneOk && hasYear && hasMileage && hasPrice) {
      count++;
    } else {
      await fetch(`https://api.vk.com/method/wall.delete`, {
        method: "POST",
        body: new URLSearchParams({
          owner_id: OWNER_ID,
          post_id: post.id,
          access_token: TOKEN,
          v: "5.199"
        })
      });
      log(`Удалён пост ${post.id}`);
    }
  }
  log(`Проверка завершена. Прошли проверку: ${count}`);
}

async function postAll() {
  const posts = await fetchSuggests();
  for (const post of posts) {
    const phoneMatch = post.text.match(/(?:\+7|8)?[\s\-]?\(?\d{3}\)?[\s\-]?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}/);
    if (phoneMatch) {
      localStorage.setItem("phone_" + phoneMatch[0], Date.now());
    }
    localStorage.setItem("id_" + post.from_id, Date.now());

    await fetch("https://api.vk.com/method/wall.post", {
      method: "POST",
      body: new URLSearchParams({
        owner_id: OWNER_ID,
        from_group: "0",
        message: post.text,
        access_token: TOKEN,
        v: "5.199"
      })
    });
    await fetch("https://api.vk.com/method/wall.delete", {
      method: "POST",
      body: new URLSearchParams({
        owner_id: OWNER_ID,
        post_id: post.id,
        access_token: TOKEN,
        v: "5.199"
      })
    });
    log(`Выложен и удалён пост ${post.id}`);
    await new Promise(r => setTimeout(r, 10000));
  }
}

// Очистка старых записей (старше 24ч)
setInterval(() => {
  const now = Date.now();
  Object.keys(localStorage).forEach(key => {
    const ts = parseInt(localStorage.getItem(key));
    if (!isNaN(ts) && now - ts > 86400000) {
      localStorage.removeItem(key);
    }
  });
}, 60000);
</script>
</body>
</html>
