
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Автовыкладка из предложки</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f8f8f8; }
    button, input { font-size: 16px; padding: 10px; margin-top: 10px; }
    pre { background: #eee; padding: 10px; height: 300px; overflow: auto; }
  </style>
</head>
<body>
  <h2>Автовыкладка постов из предложки</h2>

  <label>Время выкладки (часы:минуты, например 10:00):</label><br>
  <input type="time" id="postTime" value="10:00"><br>
  <button onclick="setAutoPost()">Запустить автовыкладку</button>
  <button onclick="stopAutoPost()">Остановить</button><br>
  <button onclick="postNow()">Выложить всё сейчас</button>

  
  <button onclick="checkPosts()">Проверить посты (по ID и телефонам)</button>
  <pre id="log"></pre>


  <script>
    const GROUP_ID = 136706358;
    const OWNER_ID = -136706358;
    let token = "";
    let autoPostInterval = null;

    function log(msg) {
      const el = document.getElementById("log");
      el.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
      el.scrollTop = el.scrollHeight;
    }

    async function getToken() {
      return new Promise((resolve) => {
        const authUrl = "https://oauth.vk.com/authorize?client_id=6121396&display=page&redirect_uri=https://oauth.vk.com/blank.html&scope=wall,groups,offline&response_type=token&v=5.154";
        const popup = window.open(authUrl, "_blank", "width=600,height=600");
        const timer = setInterval(() => {
          try {
            if (popup.location.href.includes("access_token")) {
              const hash = new URLSearchParams(popup.location.hash.substr(1));
              token = hash.get("access_token");
              popup.close();
              clearInterval(timer);
              log("Токен получен");
              resolve(token);
            }
          } catch (e) {}
        }, 500);
      });
    }

    async function postNow() {
      if (!token) await getToken();

      const suggests = await fetch(`https://api.vk.com/method/wall.get?owner_id=${OWNER_ID}&filter=suggests&count=100&access_token=${token}&v=5.154`)
        .then(res => res.json());

      if (!suggests.response || !suggests.response.items.length) {
        log("Нет постов в предложке");
        return;
      }

      for (const post of suggests.response.items) {
        const postId = post.id;
        const message = post.text;
        const attachments = (post.attachments || [])
          .map(att => {
            const item = att[att.type];
            return `${att.type}${item.owner_id}_${item.id}`;
          }).join(',');

        const postResult = await fetch("https://api.vk.com/method/wall.post", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({
            owner_id: `-${GROUP_ID}`,
            message,
            attachments,
            access_token: token,
            v: "5.154"
          })
        }).then(r => r.json());

        if (postResult.response) {
          log(`Опубликован пост ${postId}`);
          await fetch(`https://api.vk.com/method/wall.delete?owner_id=${OWNER_ID}&post_id=${postId}&access_token=${token}&v=5.154`);
          log(`Удалён из предложки ${postId}`);
        } else {
          log(`Ошибка поста ${postId}: ${JSON.stringify(postResult.error)}`);
        }

        await new Promise(r => setTimeout(r, 10000)); // 10 сек пауза
      }
    }

    function setAutoPost() {
      const time = document.getElementById("postTime").value;
      log("Автовыкладка включена на " + time);
      if (autoPostInterval) clearInterval(autoPostInterval);
      autoPostInterval = setInterval(() => {
        const now = new Date();
        const h = now.getHours().toString().padStart(2, '0');
        const m = now.getMinutes().toString().padStart(2, '0');
        if (`${h}:${m}` === time) {
          postNow();
        }
      }, 30000);
    }

    function stopAutoPost() {
      if (autoPostInterval) {
        clearInterval(autoPostInterval);
        autoPostInterval = null;
        log("Автовыкладка остановлена");
      }
    }
  
    async function checkPosts() {
      if (!token) await getToken();

      const suggests = await fetch(`https://api.vk.com/method/wall.get?owner_id=${OWNER_ID}&filter=suggests&count=100&access_token=${token}&v=5.154`)
        .then(res => res.json());

      if (!suggests.response || !suggests.response.items.length) {
        log("Нет постов в предложке для проверки");
        return;
      }

      const posts = suggests.response.items;
      const seenPhones = new Set();
      const seenAuthors = new Set();
      let removed = 0;

      for (const post of posts) {
        const postId = post.id;
        const text = post.text || "";
        const fromId = post.from_id;

        const phoneMatch = text.match(/\b(?:\+?7|8)[\s-]?\(?\d{3}\)?[\s-]?\d{3}[\s-]?\d{2}[\s-]?\d{2}\b/g);
        const phone = phoneMatch ? phoneMatch[0].replace(/\D/g, '') : null;

        const hasDuplicatePhone = phone && seenPhones.has(phone);
        const hasDuplicateAuthor = seenAuthors.has(fromId);
        const hasNoPhone = !phone;

        if (hasDuplicatePhone || hasDuplicateAuthor || hasNoPhone) {
          await fetch(`https://api.vk.com/method/wall.delete?owner_id=${OWNER_ID}&post_id=${postId}&access_token=${token}&v=5.154`);
          log(`Удалён пост ${postId} — ${hasDuplicatePhone ? "повтор телефона" : hasDuplicateAuthor ? "повтор ID" : "нет телефона"}`);
          removed++;
        } else {
          if (phone) seenPhones.add(phone);
          seenAuthors.add(fromId);
        }
      }

      log(`Проверка завершена. Удалено постов: ${removed}`);
    }

  </script>
</body>
</html>
